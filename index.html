<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart LMS - Student Universe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', 'Noto Sans Sinhala', sans-serif; 
            background: linear-gradient(135deg, #f6f9ff 0%, #eef2f7 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 24px;
        }
        .live-dot {
            width: 10px;
            height: 10px;
            background-color: #ff4757;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 rgba(255, 71, 87, 0.4);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }
        .grad-text {
            background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .vibrant-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .vibrant-btn:hover {
            transform: scale(1.05);
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 16px;
            background: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
    </style>
</head>
<body class="min-h-screen pb-12">

    <!-- Top Navigation -->
    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-blue-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200">
                    <i class="fas fa-rocket text-white"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl text-slate-800 leading-none">Smart LMS</h1>
                    <span class="text-[10px] uppercase tracking-widest text-blue-500 font-bold">Student Universe</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex bg-slate-100 px-4 py-2 rounded-full items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="text-xs font-semibold text-slate-600 italic">Guest Access Active</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Dashboard Content -->
    <div id="main-dashboard-content">
        <main class="max-w-7xl mx-auto px-6 mt-8 space-y-10">
            <!-- Hero Welcome -->
            <section class="relative overflow-hidden rounded-[32px] p-8 md:p-12 bg-slate-900 text-white shadow-2xl">
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-8">
                    <div class="text-center md:text-left space-y-4">
                        <h2 class="text-4xl md:text-5xl font-extrabold">ආයුබෝවන්, <span class="grad-text">ශිෂ්‍යයා!</span></h2>
                        <p class="text-slate-400 max-w-md">අද ඔයාගේ ඉගෙනුම් ගමන කොහොමද? පහළ තියෙන පන්ති සහ පාඩම් මාලා එක්ක එකතු වෙන්න.</p>
                    </div>
                    <div class="hidden lg:block relative">
                        <i class="fas fa-user-astronaut text-[120px] text-blue-400 animate-bounce" style="animation-duration: 4s;"></i>
                    </div>
                </div>
            </section>

            <!-- Live Section -->
            <section>
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                        <span class="live-dot"></span> සජීවී පන්ති (Live Now)
                    </h3>
                </div>
                <div id="student-live-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </section>

            <!-- Study Packs Grid -->
            <section id="packs-section">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                        <i class="fas fa-layer-group text-blue-500"></i> පාඩම් මාලා (Study Packs)
                    </h3>
                </div>
                <div id="student-packs-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
            </section>
        </main>
    </div>

    <!-- Lessons Display Section (Inside Pack View) -->
    <div id="lessons-page-view" class="hidden">
        <main class="max-w-7xl mx-auto px-6 mt-8 space-y-10">
            <section class="space-y-6">
                <div class="flex items-center justify-between bg-white p-6 rounded-[24px] shadow-sm border border-slate-100">
                    <div class="flex items-center gap-4">
                        <button onclick="closeLessons()" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 hover:bg-slate-200 transition">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h3 id="selected-pack-name" class="text-2xl font-bold text-slate-800">පාඩම් මාලාව</h3>
                    </div>
                    <span class="bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest">Active Pack</span>
                </div>
                <!-- Lesson Grid where videos will be shown -->
                <div id="lessons-grid" class="grid grid-cols-1 lg:grid-cols-1 gap-6"></div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDUvR4OkKz0IQju7dRGju6uDnEYdeyVe3g", 
            authDomain: "malinda-lms.firebaseapp.com", 
            databaseURL: "https://malinda-lms-default-rtdb.firebaseio.com", 
            projectId: "malinda-lms", 
            storageBucket: "malinda-lms.firebasestorage.app", 
            messagingSenderId: "668911175736", 
            appId: "1:668911175736:web:01b3732c6313e696603ecd" 
        };

        const app = initializeApp(firebaseConfig); 
        const db = getDatabase(app); 
        const appId = "malinda-lms";

        // Extract YouTube Video ID from various URL formats
        function getYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        window.closeLessons = () => {
            document.getElementById('lessons-page-view').classList.add('hidden');
            document.getElementById('main-dashboard-content').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.fetchLessons = (packId, packName) => {
            document.getElementById('main-dashboard-content').classList.add('hidden');
            document.getElementById('lessons-page-view').classList.remove('hidden');
            document.getElementById('selected-pack-name').innerText = packName;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            const lessonsGrid = document.getElementById('lessons-grid');
            lessonsGrid.innerHTML = '<p class="text-slate-400 italic px-6">පාඩම් පරීක්ෂා කරමින්...</p>';

            onValue(ref(db, `artifacts/${appId}/public/data/lessons/${packId}`), (snap) => {
                const data = snap.val();
                lessonsGrid.innerHTML = '';
                if(data) {
                    Object.keys(data).forEach(k => {
                        const l = data[k];
                        const videoId = getYouTubeId(l.youtubeUrl);
                        
                        // Modified UI: Show video inside an iframe directly to hide the source link
                        lessonsGrid.innerHTML += `
                            <div class="glass-card overflow-hidden shadow-lg border border-slate-200">
                                <div class="p-6">
                                    <h5 class="font-bold text-slate-800 text-xl mb-2">${l.name}</h5>
                                    <p class="text-sm text-slate-500 mb-6">${l.description || 'මෙම පාඩම ඉහළ ඇති වීඩියෝවෙන් නරඹන්න.'}</p>
                                    
                                    ${videoId ? `
                                        <div class="video-container">
                                            <iframe 
                                                src="https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&showinfo=0" 
                                                allowfullscreen
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                                            </iframe>
                                        </div>
                                    ` : `<div class="p-8 bg-slate-100 rounded-xl text-center text-slate-400">වීඩියෝව ලබාගත නොහැක.</div>`}
                                </div>
                            </div>`;
                    });
                } else {
                    lessonsGrid.innerHTML = `
                        <div class="col-span-full py-20 text-center glass-card">
                            <i class="fas fa-folder-open text-slate-300 text-4xl mb-3"></i>
                            <p class="text-slate-400">මෙම පාඩම් මාලාව යටතේ තවමත් පාඩම් එකතු කර නැත.</p>
                        </div>`;
                }
            });
        };

        onValue(ref(db, `artifacts/${appId}/public/data/live_classes`), (snap) => {
            const data = snap.val(); 
            const cont = document.getElementById('student-live-list'); 
            cont.innerHTML = '';
            if(data) {
                Object.keys(data).forEach(k => { 
                    const c = data[k]; 
                    const dateObj = new Date(c.time);
                    cont.innerHTML += `
                        <div class="glass-card p-6 flex justify-between items-center shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                            <div class="flex items-center gap-5">
                                <div class="w-16 h-16 bg-blue-100 rounded-2xl flex flex-col items-center justify-center text-blue-600 border border-blue-200">
                                    <span class="text-xs font-bold uppercase">${dateObj.toLocaleDateString('en-US', {month: 'short'})}</span>
                                    <span class="text-xl font-black leading-none">${dateObj.getDate()}</span>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-lg">${c.name}</h4>
                                    <div class="flex items-center gap-3 mt-1 text-slate-500 text-sm">
                                        <span><i class="far fa-clock mr-1 text-blue-400"></i> ${dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                </div>
                            </div>
                            <a href="${c.link}" target="_blank" class="vibrant-btn text-white px-6 py-3 rounded-2xl text-sm font-bold shadow-lg shadow-blue-200">Join Now</a>
                        </div>`; 
                });
            } else {
                cont.innerHTML = '<p class="col-span-full text-center text-slate-400 py-6">දැනට සජීවී පන්ති නොමැත.</p>';
            }
        });

        onValue(ref(db, `artifacts/${appId}/public/data/study_packs`), (snap) => {
            const data = snap.val(); 
            const cont = document.getElementById('student-packs-list'); 
            cont.innerHTML = '';
            const gradients = ['from-blue-400 to-indigo-500', 'from-purple-400 to-pink-500', 'from-orange-400 to-red-500', 'from-emerald-400 to-teal-500'];
            
            if(data) {
                let i = 0;
                Object.keys(data).forEach(k => { 
                    const p = data[k];
                    const grad = gradients[i % gradients.length];
                    cont.innerHTML += `
                        <div class="bg-white p-4 rounded-[32px] shadow-sm hover:shadow-2xl transition-all duration-500 group border border-slate-100 overflow-hidden relative">
                            <div class="h-40 bg-gradient-to-br ${grad} rounded-2xl mb-4 flex items-center justify-center relative overflow-hidden">
                                <i class="fas fa-play-circle text-white/40 text-6xl group-hover:scale-110 transition duration-500"></i>
                            </div>
                            <div class="px-2 pb-2">
                                <h4 class="font-bold text-slate-800 mb-1 truncate">${p.name}</h4>
                                <div class="flex justify-between items-center mt-3">
                                    <span class="text-blue-600 font-black">Rs. ${p.price}</span>
                                </div>
                                <button onclick="window.fetchLessons('${k}', '${p.name}')" class="w-full mt-5 bg-slate-900 text-white py-3 rounded-xl text-xs font-bold hover:bg-blue-600 transition shadow-xl">Get Access</button>
                            </div>
                        </div>`; 
                    i++;
                });
            } else {
                cont.innerHTML = '<p class="col-span-full text-center text-slate-400 py-12">පාඩම් මාලා හමු නොවීය.</p>';
            }
        });
    </script>
</body>
</html>
